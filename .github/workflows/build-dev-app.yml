name: Build dev-app

on:
  pull_request:
    types: [synchronize, opened]

jobs:
  dev-app-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      # Setup cache for node modules.
      - uses: actions/cache@v2
        with:
          path: |
            **/node_modules
          # Cache key. Whenever the postinstall patches change, the cache needs to be invalidated.
          # If just the `yarn.lock` file changes, the most recent cache can be restored though.
          # See: https://docs.github.com/en/actions/guides/caching-dependencies-to-speed-up-workflows#example-using-the-cache-action.
          key: v2-${{hashFiles('tools/postinstall/apply-patches.js')}}-${{hashFiles('yarn.lock')}}
          restore-keys: v2-${{hashFiles('tools/postinstall/apply-patches.js')}}-

      - run: yarn install --frozen-lockfile --non-interactive
      - run: ./scripts/bazel/setup-remote-execution.sh
        env:
          GCP_DECRYPT_TOKEN: angular

      # Build the web package. Note that we also need to make the Github environment
      # variables available so that the RBE is configured.
      - name: Building dev-app
        run: |
          source ${GITHUB_ENV}
          bazel build //src/dev-app:web_package --symlink_prefix=dist/

      # Prepare the workflow artifact that is available for the deploy workflow. We store the pull
      # request number in a file that can be read by the deploy workflow. This is necessary so that
      # the deploy workflow can create a comment on the PR that triggered the deployment.
      - run: |
          mkdir -p dist/devapp
          cp -R dist/bin/src/dev-app/web_package/* dist/devapp
          echo ${{github.event.pull_request.number}} > dist/devapp/pr_number
          echo ${{github.event.pull_request.head.sha}} > dist/devapp/pr_sha

      # Upload the generated dev-app archive.
      - uses: actions/upload-artifact@v2
        with:
          name: devapp
          path: dist/devapp
